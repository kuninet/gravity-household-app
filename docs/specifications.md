# 機能仕様書

## 1. レシートOCR機能 (`ReceiptOCR.vue`)
Gemini API (AI) を使用して、レシート画像やPDFから品目と金額を自動抽出します。

### 仕様詳細
- **利用モデル**: `gemini-2.0-flash`, `gemini-flash-latest`, `gemini-2.0-flash-lite` を優先利用し、失敗時は `gemini-1.5-pro` 等へフォールバックします。
- **税区分設定**:
  - ユーザーは解析前に「税込」「税抜」を選択可能。
  - **税抜モード**の場合: 
    - 食費カテゴリ (コード100-199): **税抜8%** として扱われ、合計計算時に `amount * 1.08` されます。
    - その他カテゴリ: **税抜10%** として扱われ、合計計算時に `amount * 1.10` されます。
    - これにより、内訳画面へ渡される合計額は常に**税込**となります。
- **ドラッグ＆ドロップ対応**: ファイル選択ボタンに加え、枠内へのドロップでもアップロード可能です。

## 2. レシート内訳計算 (`ReceiptSplitter.vue`)
レシートの「支払合計（税込）」から、個別の明細を差し引いて「残額（主に食費など）」を算出します。複数品目の登録を支援します。

### 計算ロジック
- **入力**: 支払合計 (A)
- **明細行**: 各行の金額 (b1, b2...) と税区分
  - 税区分が「税抜8%」なら `b * 1.08` (端数切り捨て)
  - 税区分が「税抜10%」なら `b * 1.10` (端数切り捨て)
- **残額**: `A - Σ(b_tax_included)`

### 自動入力機能
- カテゴリを選択した際、コードが 100番台（食費）なら自動的に「税抜8%」、それ以外なら「税抜10%」がデフォルトセットされます。

## 3. 固定費管理 (`FixedCostManager.vue`)
年間の固定費（家賃、光熱費など）をマトリクス形式で表示・編集します。

### Excelペースト機能
- Excelからコピーしたデータを、画面上の任意のセルで `Ctrl+V` (Cmd+V) することで貼り付け可能です。
- クリップボードのTSVデータを解析し、セル位置を起点として右・下方向にデータを一括更新します (`/api/fixed-costs/batch_update`)。

## 4. データ管理: エクスポート・バックアップ (`ExcelImport.vue`, `backup.js`)
データの保全と外部連携のための機能群です。

### フルバックアップ
- **形式**: CSV
- **文字コード**: Shift_JIS (Excelでの直接閲覧を考慮)
- **対象**: `transactions` テーブルの全データ
- **ダウンロード**: `/api/backup/export` より直接配信

### リストア (復元)
- アップロードされたCSV (Shift_JIS) を解析し、データベースを**全消去**した上でインサートします。
- 一貫性を保つため、トランザクション内で処理されます。

### データ全削除
- 「危険な操作」エリアから実行。
- 二重の確認ダイアログを経て、`transactions` テーブルを `TRUNCATE` (SQLiteでは `DELETE`) します。
- `sqlite_sequence` もリセットされ、IDは1から再番されます。

## 5. Excelインポート (テンプレート読込) (`import.js`)
特定のフォーマットのExcelファイルを取り込みます。

### 対応フォーマット
1. **日々の記録シート**: シート名 `yyyy年m月`
   - A列: 日付, B列: カテゴリコード, C列: 金額, E列: 品名, F列: 備考
2. **固定費シート (標準)**: シート名 `yyyy年公共料金等`
3. **固定費シート (代替)**: シート名 `yyyy合計`
   - G列: 家賃, H列: 電気, I+J列: ガス, K列: 水道...
   - 3行目がヘッダー、4行目からデータ開始

### 動作
- 指定された期間（年、または全期間）のデータについて、該当する `fiscal_month` の既存データを削除し、Excelの内容で上書きします（洗い替え方式）。
