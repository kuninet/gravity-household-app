# トラブルシューティングガイド

エラーが発生した場合の調査ポイントと対応方法です。

## 1. サーバーエラー / APIエラー (500 Internal Server Error)

### 症状
- 画面上に「エラーが発生しました」と表示される。
- コンソールに `POST /api/xxx 500` のようなエラーが出る。

### 調査方法
1. **サーバーログの確認**:
   ターミナル（`npm run dev` を実行している画面）を確認してください。バックエンドの詳細なエラースタックトレースが出力されています。
   
   ```bash
   [0] Reset Error: Error: SQLITE_ERROR: ...
   ```

2. **よくある原因**:
   - **DBロック**: SQLiteファイルが別のプロセスで開かれている、または処理が競合している。
   - **構文エラー**: 直近で修正したサーバーサイドコード (`server/routes/*.js`) に文法ミスがある。

## 2. Gemini OCR が動かない / 失敗する

### 症状
- 「解析に失敗しました」と表示される。
- ローディングがずっと終わらない。

### チェックポイント
1. **APIキーの設定**:
   `server/.env` ファイルに `GEMINI_API_KEY` が正しく設定されているか確認してください。
   
2. **モデルの可用性**:
   `server/routes/ocr.js` では以下の順序でモデル利用を試みます。すべてのモデルで404やエラーが返る場合、APIキーの権限不足や、無料枠の制限到達が考えられます。
   1. `gemini-2.0-flash`
   2. `gemini-flash-latest`
   3. `gemini-2.0-flash-lite`
   4. `gemini-1.5-flash`
   5. `gemini-1.5-pro`
   6. `gemini-pro-vision`

3. **画像サイズ/形式**:
   極端に大きな画像や、対応していない形式の場合、Gemini APIがエラーを返すことがあります。

## 3. バックアップ・CSV関連エラー

### 症状
- ダウンロードしたCSVが文字化けする。
- リストア時にエラーになる。

### 対応
- **文字コード**: 本システムは **Shift_JIS** を標準としています。UTF-8のCSVをインポートしようとすると文字化けや解析エラーになります。
- **Excelでの確認**: インポート用ファイルはExcelで一度開いて保存しなおすと、フォーマットが整うことがあります。

## 4. 起動しない / 画面が表示されない

### 症状
- `npm run dev` しても `localhost:5173` に繋がらない。
- プロキシエラー (`ECONNREFUSED`) が出る。

### 対応
- **ポート競合**: ポート 3001 (Server) や 5173 (Client) が既に使用されていないか確認してください。
- `lsof -i :3001` 等で確認し、プロセスをキルして再起動してください。
- サーバー側 (`[0]`) がエラーでクラッシュして落ちている場合があります。ターミナルのログを確認し、エラーを取り除いてください。

---
## 開発時のデバッグ
- **フロントエンド**: ブラウザの DevTools > Network タブで、APIリクエストの Payload と Response を確認するのが最も早道です。
- **バックエンド**: `console.log` をコードに埋め込むと、ターミナルに出力されます。
